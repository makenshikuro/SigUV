var object,isPlay=!1;function initPanorama(e){var n,a;n=document.getElementById("visor-panorama"),camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1100),camera.target=new THREE.Vector3(0,0,0),scene=new THREE.Scene;var t=new THREE.TextureLoader;t.crossOrigin=!0,t.load(_server+"panoramas/"+e,function(e){var n=new THREE.SphereGeometry(500,60,40);n.scale(-1,1,1);var t=new THREE.MeshBasicMaterial({map:e});a=new THREE.Mesh(n,t),object=a,scene.add(a)}),renderer=new THREE.WebGLRenderer,renderer.setPixelRatio(window.devicePixelRatio),$(".pano").css("max-width",window.innerWidth/2+30),$(".pano").css("margin-top",100),renderer.setSize(window.innerWidth/2,window.innerHeight/2),n.appendChild(renderer.domElement),document.addEventListener("mousedown",onDocumentMouseDown,!1),document.addEventListener("mousemove",onDocumentMouseMove,!1),document.addEventListener("mouseup",onDocumentMouseUp,!1),document.addEventListener("mousewheel",onDocumentMouseWheel,!1),document.addEventListener("MozMousePixelScroll",onDocumentMouseWheel,!1),document.addEventListener("dragover",function(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"},!1),document.addEventListener("dragenter",function(e){document.body.style.opacity=.5},!1),document.addEventListener("dragleave",function(e){document.body.style.opacity=1},!1),document.addEventListener("drop",function(e){e.preventDefault();var n=new FileReader;n.addEventListener("load",function(e){material.map.image.src=e.target.result,material.map.needsUpdate=!0},!1),n.readAsDataURL(e.dataTransfer.files[0]),document.body.style.opacity=1},!1),WindowResize();$("canvas").after('<div class="panorama-control"><div id="iniR" title="Iniciar Rotación" onclick="iniciaRotacion();" class="control-pano button"><i class="large material-icons">play_arrow</i></i></div><div id="stopR" title="Detener Rotación" onclick="detenerRotacion();" class="control-pano button"><i class="large material-icons">stop</i></div><div id="fullscreen" title="Activar Pantalla Completa" onclick="fullscreen();" class="control-pano button request"><i class="large material-icons">fullscreen</i></div><div id="fullscreen_cancel" title="Desactivar Pantalla Completa" onclick="cancelFullScreen();" style="display: none;" class="control-pano button cancel"><i class="large material-icons">fullscreen_exit</i></div></div>'),$("#stopR").hide(),isPlay=!1,THREEx.FullScreen.bindKey({dblclick:!0}),document.querySelector(".button.request").addEventListener("click",function(){THREEx.FullScreen.request()},!1),document.querySelector(".button.cancel").addEventListener("click",function(){THREEx.FullScreen.cancel()},!1),$("canvas").mousedown(function(e){onDocumentMouseDown(e)})}function Change(e,n){var t=new THREE.TextureLoader;t.crossOrigin=!0;var a=t.load(_server+"panoramas/"+e);object.material.map=a,object.material.needsUpdate=!0;var i=$("ul.pagination.panorama li").length;for(indice=0;indice<i;indice++)indice===n?$("#panoTab"+indice).addClass("active"):$("#panoTab"+indice).removeClass("active")}function cancelFullScreen(){WindowResize()}function WindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),$(".pano").css("max-width",window.innerWidth/2+30),$("panorama-control").css("width",window.innerWidth/2),renderer.setSize(window.innerWidth/2,window.innerHeight/2),$("#fullscreen").show(),$("#fullscreen_cancel").hide()}function fullscreen(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),$(".pano").css("max-width",window.innerWidth),$(".pano").css({width:"100%",height:"auto"}),$("#fullscreen").hide(),$("#fullscreen_cancel").show(),renderer.setSize(window.innerWidth,window.innerHeight),THREEx.FullScreen.request()}function iniciaRotacion(){$("#iniR").hide(),$("#stopR").show(),isPlay=!0}function detenerRotacion(){$("#stopR").hide(),$("#iniR").show(),isPlay=!1}function onDocumentMouseDown(e){e.preventDefault(),isUserInteracting=!0,onPointerDownPointerX=e.clientX,onPointerDownPointerY=e.clientY,onPointerDownLon=lon,onPointerDownLat=lat}function onDocumentMouseMove(e){!0===isUserInteracting&&(lon=.1*(onPointerDownPointerX-e.clientX)+onPointerDownLon,lat=.1*(e.clientY-onPointerDownPointerY)+onPointerDownLat)}function onDocumentMouseUp(e){isUserInteracting=!1}function onDocumentMouseWheel(e){e.wheelDeltaY?camera.fov-=.05*e.wheelDeltaY:e.wheelDelta?camera.fov-=.05*e.wheelDelta:e.detail&&(camera.fov+=1*e.detail),camera.updateProjectionMatrix()}function animate(){requestAnimationFrame(animate),update()}function update(){!0===isPlay&&!1===isUserInteracting&&(lon+=.1),lat=Math.max(-85,Math.min(85,lat)),phi=THREE.Math.degToRad(90-lat),theta=THREE.Math.degToRad(lon),camera.target.x=500*Math.sin(phi)*Math.cos(theta),camera.target.y=500*Math.cos(phi),camera.target.z=500*Math.sin(phi)*Math.sin(theta),camera.lookAt(camera.target),renderer.render(scene,camera)}